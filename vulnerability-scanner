#!/bin/bash

# Check if target is provided
if [ -z "$1" ]; then
    echo "Usage: $0 <target-ip>"
    exit 1
fi

TARGET=$1

echo "[*] Scanning $TARGET for open ports..."
open_ports=$(nmap -p- --min-rate=1000 -T4 $TARGET | grep "open" | awk '{print $1}' | tr -d '/tcp')

echo "[*] Found open ports: $open_ports"

# Perform an Nmap vulnerability scan using NSE scripts
echo "[*] Running Nmap vulnerability scan..."
nmap --script=/usr/share/nmap/scripts/vulscan/ -sV -p- $TARGET > nmap_vuln_results.txt
echo "[*] Vulnerability scan completed. Check nmap_vuln_results.txt for details."

# Check for Default Credentials
echo "[*] Checking for default credentials..."
if [[ "$open_ports" == *"22"* ]]; then
    echo "[*] Checking SSH default credentials..."
    sshpass -p "toor" ssh -o StrictHostKeyChecking=no root@$TARGET "echo 'SSH access with default root password!'" 2>/dev/null
fi

if [[ "$open_ports" == *"21"* ]]; then
    echo "[*] Checking FTP default credentials..."
    echo "USER anonymous" | nc $TARGET 21 | grep "230" && echo "Anonymous FTP login allowed!"
fi

if [[ "$open_ports" == *"3306"* ]]; then
    echo "[*] Checking MySQL default credentials..."
    mysql -h $TARGET -u root -p'root' -e "SHOW DATABASES;" 2>/dev/null && echo "Default MySQL credentials found!"
fi

echo "[*] Default credential checks completed."

# Extract Service Versions and Query CVE Database
echo "[*] Extracting service versions..."
services=$(nmap -sV -p- $TARGET | grep -E "^[0-9]+/tcp" | awk '{print $1, $3, $4}' | tr -d '/tcp')

echo "[*] Checking for known vulnerabilities..."
for service in $services; do
    port=$(echo $service | awk '{print $1}')
    software=$(echo $service | awk '{print $2}')
    version=$(echo $service | awk '{print $3}')

    if [ ! -z "$software" ] && [ ! -z "$version" ]; then
        echo "Searching CVEs for $software $version..."
        curl -s "https://cve.circl.lu/api/search/$software/$version" | jq '.'
    fi
done

echo "[*] Scan completed."

